<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Analytics Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load dayjs and necessary plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 50vh; /* Main chart height */
            width: 90%;
            max-width: 800px;
        }
        /* Smaller containers for additional charts */
        .small-chart-container {
             position: relative;
             margin: auto;
             height: 45vh; /* Slightly smaller */
             width: 95%; /* Take up most of column width */
             max-width: 500px; /* Limit max width */
        }
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: white;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-md p-6"> <!-- Increased max-width slightly -->
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Disaster Impact Dashboard</h1>

        <!-- Filter Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 items-end">
             <div>
                <label for="provinceFilter" class="block text-sm font-medium text-gray-700 mb-1">Province</label>
                <select id="provinceFilter" name="province" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Provinces</option>
                </select>
            </div>
            <div>
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Disaster Category</label>
                <select id="categoryFilter" name="category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                 <div>
                    <label for="startDateFilter" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="startDateFilter" name="start_date" class="mt-1 block w-full text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                </div>
                 <div>
                    <label for="endDateFilter" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" id="endDateFilter" name="end_date" class="mt-1 block w-full text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                </div>
            </div>
            <div>
                <button id="applyFiltersBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Loading / Error Messages -->
        <div id="loading" class="text-center text-gray-500 my-4">Loading data...</div>
        <div id="error" class="text-center text-red-500 my-4 hidden"></div>
        <div id="noData" class="text-center text-gray-500 my-4 hidden">No data available for the selected filters.</div>

        <!-- Main Bar Chart Canvas -->
        <div class="chart-container mb-12"> <!-- Increased bottom margin -->
            <canvas id="lossesChart"></canvas>
        </div>

        <!-- Row for Additional Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- Line Chart Container -->
            <div class="small-chart-container bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                 <h2 class="text-lg font-semibold text-center text-gray-700 mb-3">Losses Over Time (Monthly)</h2>
                <canvas id="timeSeriesChart"></canvas>
            </div>
             <!-- Pie Chart Container -->
            <div class="small-chart-container bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                 <h2 class="text-lg font-semibold text-center text-gray-700 mb-3">Loss Distribution by Category</h2>
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>


        <!-- Data Table -->
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Detailed Records (Max 100 shown)</h2>
        <div class="overflow-x-auto shadow rounded-lg">
            <table id="dataTable" class="min-w-full bg-white border border-gray-200 hidden">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date Start</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Province</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Municipality</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Commodity</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Disaster Category</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Losses PHP Grand Total</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Farmers Affected</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="divide-y divide-gray-200">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // --- Enable Dayjs plugins ---
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_customParseFormat);

        // --- Constants and Globals ---
        const baseApiUrl = 'http://localhost:8000/api/disaster_summary';
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const noDataDiv = document.getElementById('noData');
        const dataTable = document.getElementById('dataTable');
        const dataTableBody = document.getElementById('dataTableBody');

        // Chart elements and variables
        const barChartCanvas = document.getElementById('lossesChart');
        const timeSeriesCanvas = document.getElementById('timeSeriesChart');
        const categoryPieCanvas = document.getElementById('categoryPieChart');
        let barChartInstance = null;
        let timeSeriesChartInstance = null;
        let categoryPieChartInstance = null;

        // Filter elements
        const provinceFilter = document.getElementById('provinceFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');

        // --- Helper: Format Numbers ---
        function formatNumber(value) {
            if (value >= 1e9) return (value / 1e9).toFixed(1) + ' B';
            if (value >= 1e6) return (value / 1e6).toFixed(1) + ' M';
            if (value >= 1e3) return (value / 1e3).toFixed(1) + ' K';
            return !isNaN(parseFloat(value)) ? value : 0;
        }
        function formatCurrency(value) {
            const numericValue = parseFloat(value);
            return (isNaN(numericValue) ? 0 : numericValue).toLocaleString('en-US', { style: 'currency', currency: 'PHP' });
        }
        function formatInt(value) {
            const intValue = parseInt(value, 10);
            return (isNaN(intValue) ? 0 : intValue).toLocaleString();
        }

        // --- Fetch and Populate Filter Dropdowns ---
        async function populateFilters() {
            console.log("Populating filters...");
            try {
                const response = await fetch(`${baseApiUrl}?limit=5000`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    const allData = result.data;
                    const provinces = [...new Set(allData.map(item => item.province).filter(p => p && p !== 'Unknown'))].sort();
                    const categories = [...new Set(allData.map(item => item.disaster_category).filter(c => c && c !== 'Unknown'))].sort();

                    provinces.forEach(p => provinceFilter.add(new Option(p, p)));
                    categories.forEach(c => categoryFilter.add(new Option(c, c)));
                    console.log("Filters populated.");
                } else {
                     console.error("Could not fetch data to populate filters:", result.message || "Unknown error");
                }
            } catch (error) {
                 console.error('Error fetching data for filters:', error);
                 errorDiv.textContent = `Error populating filters: ${error.message}. Check API server.`;
                 errorDiv.classList.remove('hidden');
            }
        }


        // --- Fetch Data Based on Filters and Display ---
        async function fetchDataAndDisplay() {
            loadingDiv.style.display = 'block';
            errorDiv.classList.add('hidden');
            noDataDiv.classList.add('hidden');
            dataTable.classList.add('hidden');
            dataTableBody.innerHTML = '';
            // Destroy existing charts
            if (barChartInstance) barChartInstance.destroy();
            if (timeSeriesChartInstance) timeSeriesChartInstance.destroy();
            if (categoryPieChartInstance) categoryPieChartInstance.destroy();

            // Build API URL with Filters
            const params = new URLSearchParams();
            const province = provinceFilter.value;
            const category = categoryFilter.value;
            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (province) params.append('province', province);
            if (category) params.append('disaster_category', category);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            params.append('limit', 5000); // Fetch more data for better chart aggregation

            const filteredApiUrl = `${baseApiUrl}?${params.toString()}`;
            console.log("Fetching data from:", filteredApiUrl);

            try {
                const response = await fetch(filteredApiUrl);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errorData = await response.json(); if (errorData && errorData.message) errorMsg += ` - ${errorData.message}`; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const result = await response.json();

                if (result.status === 'success' && result.data && result.data.length > 0) {
                    const data = result.data;
                    console.log(`Filtered data fetched: ${data.length} items`);

                    // --- 1. Prepare Data for Bar Chart ---
                    let barGroupByKey = 'province';
                    let barChartTitle = 'Total Disaster Losses by Province';
                    if (province && !category) { barGroupByKey = 'disaster_category'; barChartTitle = `Losses by Disaster Category in ${province}`; }
                    else if (province && category) { barGroupByKey = 'municipality'; barChartTitle = `Losses by Municipality in ${province} (${category})`; }
                    else if (!province && category) { barGroupByKey = 'province'; barChartTitle = `Losses from ${category} by Province`; }

                    const lossesByBarGroup = data.reduce((acc, item) => {
                        const key = item[barGroupByKey] || 'Unknown';
                        const lossValue = parseFloat(item.losses_php_grand_total);
                        acc[key] = (acc[key] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                        return acc;
                    }, {});

                    // --- 2. Prepare Data for Line Chart (Monthly Losses) ---
                    const lossesByMonth = data.reduce((acc, item) => {
                        if (item.event_date_start && item.event_date_start !== 'N/A') {
                            // Use dayjs to handle potential date format issues
                            const monthYear = dayjs(item.event_date_start).isValid() ? dayjs(item.event_date_start).format('YYYY-MM') : 'Invalid Date';
                             if (monthYear !== 'Invalid Date') {
                                const lossValue = parseFloat(item.losses_php_grand_total);
                                acc[monthYear] = (acc[monthYear] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                            }
                        }
                        return acc;
                    }, {});
                    // Sort months chronologically
                    const sortedMonths = Object.keys(lossesByMonth).sort();
                    const monthlyLossValues = sortedMonths.map(month => lossesByMonth[month]);

                    // --- 3. Prepare Data for Pie Chart (Category Distribution) ---
                    const lossesByCategory = data.reduce((acc, item) => {
                        const key = item.disaster_category || 'Unknown';
                        const lossValue = parseFloat(item.losses_php_grand_total);
                        acc[key] = (acc[key] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                        return acc;
                    }, {});
                    const categoryLabels = Object.keys(lossesByCategory);
                    const categoryLossValues = Object.values(lossesByCategory);


                    // --- Create Bar Chart ---
                    const barCtx = barChartCanvas.getContext('2d');
                    barChartInstance = new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(lossesByBarGroup),
                            datasets: [{ label: 'Losses PHP Grand Total', data: Object.values(lossesByBarGroup), backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }]
                        },
                        options: { /* ... (options from previous version) ... */
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, title: { display: true, text: 'Losses PHP Grand Total' }, ticks: { callback: formatNumber } }, x: { title: { display: true, text: barGroupByKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) } } },
                            plugins: { legend: { display: false }, title: { display: true, text: barChartTitle }, tooltip: { callbacks: { label: ctx => `Losses PHP Grand Total: ${formatCurrency(ctx.parsed.y)}` } } }
                        }
                    });

                    // --- Create Line Chart ---
                    const lineCtx = timeSeriesCanvas.getContext('2d');
                    timeSeriesChartInstance = new Chart(lineCtx, {
                         type: 'line',
                         data: {
                             labels: sortedMonths,
                             datasets: [{
                                 label: 'Monthly Total Losses (PHP)',
                                 data: monthlyLossValues,
                                 borderColor: 'rgb(75, 192, 192)',
                                 backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                 tension: 0.1,
                                 fill: true
                             }]
                         },
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Losses (PHP)' }, ticks: { callback: formatNumber } }, x: { title: { display: true, text: 'Month' } } },
                             plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: ctx => `Total Losses: ${formatCurrency(ctx.parsed.y)}` } } }
                         }
                    });

                    // --- Create Pie Chart ---
                    const pieCtx = categoryPieCanvas.getContext('2d');
                    // Define more colors for the pie chart segments
                    const pieColors = [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(100, 255, 100, 0.7)'
                        // Add more colors if you expect many categories
                    ];
                    categoryPieChartInstance = new Chart(pieCtx, {
                         type: 'pie',
                         data: {
                             labels: categoryLabels,
                             datasets: [{
                                 label: 'Losses by Category (PHP)',
                                 data: categoryLossValues,
                                 backgroundColor: pieColors.slice(0, categoryLabels.length), // Use defined colors
                                 hoverOffset: 4
                             }]
                         },
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             plugins: { legend: { position: 'top' }, title: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } } }
                         }
                    });

                    // --- Populate Table (Limited Rows) ---
                    const tableLimit = 100; // Limit rows shown in table
                    data.slice(0, tableLimit).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.event_date_start || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.province || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.municipality || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.commodity || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.disaster_category || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${formatCurrency(item.losses_php_grand_total)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${formatInt(item.farmers_affected)}</td>
                        `;
                        dataTableBody.appendChild(row);
                     });
                     dataTable.classList.remove('hidden');


                    loadingDiv.style.display = 'none';

                } else if (result.status === 'success' && (!result.data || result.data.length === 0)) {
                    loadingDiv.style.display = 'none';
                    noDataDiv.classList.remove('hidden'); // Show no data message
                    console.log("API returned success but no data for selected filters.");
                }
                 else {
                     throw new Error(result.message || 'API returned success status but no valid data.');
                }
            } catch (error) {
                console.error('Error fetching or processing data:', error);
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `Error loading data: ${error.message}. Is the API server running and responding correctly?`;
                errorDiv.classList.remove('hidden');
            }
        }

        // --- Event Listener for Filter Button ---
        applyFiltersBtn.addEventListener('click', fetchDataAndDisplay);

        // --- Initial Load ---
        async function initializeDashboard() {
            await populateFilters();
            await fetchDataAndDisplay();
        }

        initializeDashboard();

    </script>

</body>
</html>

