<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Analytics Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load dayjs and necessary plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <!-- <<< ADDED: Dayjs plugin to get year/quarter >>> -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/quarterOfYear.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 50vh; /* Main chart height */
            width: 90%;
            max-width: 800px;
        }
        .small-chart-container {
             position: relative;
             margin: auto;
             height: 45vh;
             width: 95%;
             max-width: 500px;
        }
        input[type="date"], select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: white;
            cursor: pointer;
        }
        /* Style for N/A values in the table */
        .na-value {
            color: #9ca3af; /* gray-400 */
            font-style: italic;
        }
        /* <<< ADDED: Style for disabled inputs >>> */
        input:disabled, select:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Disaster Impact Dashboard</h1>

        <!-- Filter Section -->
        <!-- <<< MODIFIED: Grid layout to fit 8 items perfectly >>> -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 items-end">
             <div>
                <label for="provinceFilter" class="block text-sm font-medium text-gray-700 mb-1">Province</label>
                <select id="provinceFilter" name="province" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Provinces</option>
                </select>
            </div>
            <div>
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Disaster Category</label>
                <select id="categoryFilter" name="category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Categories</option>
                </select>
            </div>
            <!-- <<< ADDED: Municipality Filter (initially disabled) >>> -->
            <div>
                <label for="municipalityFilter" class="block text-sm font-medium text-gray-700 mb-1">Municipality</label>
                <select id="municipalityFilter" name="municipality" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm bg-gray-200" disabled>
                    <option value="">All (Select Province First)</option>
                </select>
            </div>
            <!-- <<< ADDED: Quarter Filter >>> -->
            <div>
                <label for="quarterFilter" class="block text-sm font-medium text-gray-700 mb-1">Quarter</label>
                <select id="quarterFilter" name="quarter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Quarters</option>
                    <option value="1">Q1 (Jan-Mar)</option>
                    <option value="2">Q2 (Apr-Jun)</option>
                    <option value="3">Q3 (Jul-Sep)</option>
                    <option value="4">Q4 (Oct-Dec)</option>
                </select>
            </div>
            <!-- <<< ADDED: Year Filter >>> -->
             <div>
                <label for="yearFilter" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                <select id="yearFilter" name="year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Years</option>
                </select>
            </div>
             <!-- <<< MODIFIED: Removed wrapper div from dates >>> -->
             <div>
                <label for="startDateFilter" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" id="startDateFilter" name="start_date" class="mt-1 block w-full text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
            </div>
             <div>
                <label for="endDateFilter" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" id="endDateFilter" name="end_date" class="mt-1 block w-full text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
            </div>
            <div>
                <button id="applyFiltersBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Loading / Error Messages -->
        <div id="loading" class="text-center text-gray-500 my-4">Loading data...</div>
        <div id="error" class="text-center text-red-500 my-4 hidden"></div>
        <div id="noData" class="text-center text-gray-500 my-4 hidden">No data available for the selected filters.</div>

        <!-- Main Bar Chart Canvas -->
        <div class="chart-container mb-12">
            <canvas id="lossesChart"></canvas>
        </div>

        <!-- Row for Additional Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- Line Chart Container -->
            <div class="small-chart-container bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                 <h2 class="text-lg font-semibold text-center text-gray-700 mb-3">Losses Over Time (Monthly)</h2>
                <canvas id="timeSeriesChart"></canvas>
            </div>
             <!-- Pie Chart Container -->
            <div class="small-chart-container bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                 <h2 class="text-lg font-semibold text-center text-gray-700 mb-3">Loss Distribution by Category</h2>
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>


        <!-- Data Table -->
        <!-- <<< MODIFIED: Added flex container for title and search bar >>> -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Detailed Records (Max 100 shown)</h2>
            <!-- <<< ADDED: Search Input >>> -->
            <div>
                <label for="tableSearch" class="sr-only">Search Table</label>
                <input type="text" id="tableSearch" placeholder="Search table..." class="block w-full pl-3 pr-4 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
            </div>
        </div>

        <div class="overflow-x-auto shadow rounded-lg">
            <table id="dataTable" class="min-w-full bg-white border border-gray-200 hidden">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date Start</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Province</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Municipality</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Commodity</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Disaster Category</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Losses PHP Grand Total</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Farmers Affected</th>
                        <!-- <<< ADDED: New Table Headers >>> -->
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Registered Farmers</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Declared Rice Area (ha)</th>
                        <th class="px-4 py-3 border-b border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Affected Farmers (%)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="divide-y divide-gray-200">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
             <div id="tableNote" class="text-xs text-gray-500 mt-2 px-1 hidden">* Farmer registry data (where available) is joined for calculation.</div>
        </div>

    </div>

    <script>
        // --- Enable Dayjs plugins ---
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_quarterOfYear); // <<< ADDED

        // --- Constants and Globals ---
        // <<< IMPORTANT: Update this URL to point to your live API >>>
        // This example assumes your portal and API are on the same server
        // and the reverse proxy is set up.
        // If your Apache is listening on 8445, you'd use:
        const baseApiUrl = 'https://27.110.161.135:8445/api/disaster_summary'; // Use the specific IP and port
        // Or if you are running locally for presentation:
        // const baseApiUrl = 'http://127.0.0.1:8002/api/disaster_summary';

        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const noDataDiv = document.getElementById('noData');
        const dataTable = document.getElementById('dataTable');
        const dataTableBody = document.getElementById('dataTableBody');
        const tableNote = document.getElementById('tableNote'); // <<< Get table note div

        // Chart elements and variables
        const barChartCanvas = document.getElementById('lossesChart');
        const timeSeriesCanvas = document.getElementById('timeSeriesChart');
        const categoryPieCanvas = document.getElementById('categoryPieChart');
        let barChartInstance = null;
        let timeSeriesChartInstance = null;
        let categoryPieChartInstance = null;
        let provinceMunicipalityMap = {}; // <<< ADDED: To store municipality data

        // Filter elements
        const provinceFilter = document.getElementById('provinceFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const municipalityFilter = document.getElementById('municipalityFilter'); // <<< ADDED
        const quarterFilter = document.getElementById('quarterFilter'); // <<< ADDED
        const yearFilter = document.getElementById('yearFilter'); // <<< ADDED
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const tableSearchInput = document.getElementById('tableSearch'); // <<< ADDED: Get search input

        // --- Helper: Format Numbers ---
        function formatNumber(value) {
            if (value >= 1e9) return (value / 1e9).toFixed(1) + ' B';
            if (value >= 1e6) return (value / 1e6).toFixed(1) + ' M';
            if (value >= 1e3) return (value / 1e3).toFixed(1) + ' K';
            // <<< MODIFIED: Handle 0 or invalid numbers correctly >>>
            return !isNaN(parseFloat(value)) ? parseFloat(value).toLocaleString() : '0';
        }
        function formatCurrency(value) {
            const numericValue = parseFloat(value);
            return (isNaN(numericValue) ? 0 : numericValue).toLocaleString('en-US', { style: 'currency', currency: 'PHP' });
        }
        function formatInt(value) {
            const intValue = parseInt(value, 10);
            return (isNaN(intValue) ? 0 : intValue).toLocaleString();
        }
        // <<< ADDED: Helper to format percentage or show N/A >>>
        function formatPercentage(value) {
            const numericValue = parseFloat(value);
             // Check for null, undefined, or NaN
             if (value === null || value === undefined || isNaN(numericValue)) {
                 return '<span class="na-value">N/A</span>';
             }
             return numericValue.toFixed(2) + '%';
        }
        // <<< ADDED: Helper to format farmer/area numbers or show N/A >>>
        function formatRegistryNumber(value) {
             const numericValue = parseFloat(value);
             // Check for null, undefined, NaN, or 0 (0 might mean no data available in registry)
             if (value === null || value === undefined || isNaN(numericValue) || numericValue === 0) {
                 return '<span class="na-value">N/A</span>';
             }
             // Format area with decimals, farmers as integers
             return value === parseInt(value, 10) ? formatInt(value) : parseFloat(value).toFixed(2).toLocaleString();
        }
        // <<< ADDED: Helper to display text or N/A >>>
        function formatText(value) {
             if (value === null || value === undefined || value === 'N/A' || value === 'Unknown' || value === '') {
                 return '<span class="na-value">N/A</span>';
             }
             return value;
        }

        // --- Fetch and Populate Filter Dropdowns ---
        async function populateFilters() {
            console.log("Populating filters...");
            try {
                // Fetch unfiltered data to get all possible provinces/categories
                const response = await fetch(`${baseApiUrl}?limit=5000`); // Fetch a large sample
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    const allData = result.data;
                    
                    const provincesSet = new Set();
                    const categoriesSet = new Set();
                    const yearsSet = new Set(); // <<< ADDED
                    provinceMunicipalityMap = {}; // Reset map

                    allData.forEach(item => {
                        const province = item.province;
                        const municipality = item.municipality;
                        const category = item.disaster_category;

                        if (province && province !== 'Unknown') {
                            provincesSet.add(province);
                            
                            if (municipality && municipality !== 'Unknown') {
                                if (!provinceMunicipalityMap[province]) {
                                    provinceMunicipalityMap[province] = new Set();
                                }
                                provinceMunicipalityMap[province].add(municipality);
                            }
                        }
                        if (category && category !== 'Unknown') {
                            categoriesSet.add(category);
                        }
                        // <<< ADDED: Populate years >>>
                        if (item.event_date_start && dayjs(item.event_date_start).isValid()) {
                            yearsSet.add(dayjs(item.event_date_start).year());
                        }
                    });

                    // Sort sets
                    const provinces = [...provincesSet].sort();
                    const categories = [...categoriesSet].sort();
                    const years = [...yearsSet].sort((a, b) => b - a); // <<< ADDED: Sort years descending
                    // Convert map sets to sorted arrays
                    for (const prov in provinceMunicipalityMap) {
                        provinceMunicipalityMap[prov] = [...provinceMunicipalityMap[prov]].sort();
                    }


                    // Clear existing options except the first "All" option
                    while (provinceFilter.options.length > 1) provinceFilter.remove(1);
                    while (categoryFilter.options.length > 1) categoryFilter.remove(1);
                    while (yearFilter.options.length > 1) yearFilter.remove(1); // <<< ADDED

                    provinces.forEach(p => provinceFilter.add(new Option(p, p)));
                    categories.forEach(c => categoryFilter.add(new Option(c, c)));
                    years.forEach(y => yearFilter.add(new Option(y, y))); // <<< ADDED
                    console.log("Filters populated.");
                } else {
                     console.error("Could not fetch data to populate filters:", result.message || "Unknown error");
                }
            } catch (error) {
                 console.error('Error fetching data for filters:', error);
                 errorDiv.textContent = `Error populating filters: ${error.message}. Check API server.`;
                 errorDiv.classList.remove('hidden');
            }
        }

        // --- <<< ADDED: Function to Update Municipality Filter >>> ---
        function updateMunicipalityFilter() {
            const selectedProvince = provinceFilter.value;
            // Clear existing municipality options
            while (municipalityFilter.options.length > 1) municipalityFilter.remove(1);
            
            if (selectedProvince && provinceMunicipalityMap[selectedProvince]) {
                // Enable filter and populate
                municipalityFilter.disabled = false;
                municipalityFilter.classList.remove('bg-gray-200');
                municipalityFilter.options[0].text = "All Municipalities"; // Change prompt text
                
                provinceMunicipalityMap[selectedProvince].forEach(mun => {
                    municipalityFilter.add(new Option(mun, mun));
                });
            } else {
                // Disable filter
                municipalityFilter.disabled = true;
                municipalityFilter.classList.add('bg-gray-200');
                municipalityFilter.options[0].text = "All (Select Province First)"; // Reset prompt text
            }
        }
        // <<< ADDED: Event listener for province filter change >>>
        provinceFilter.addEventListener('change', updateMunicipalityFilter);


        // --- <<< ADDED: Function to handle mutually exclusive time filters >>> ---
        function handleTimeFilterChange(source) {
            const quarter = quarterFilter.value;
            const year = yearFilter.value;
            const start = startDateFilter.value;
            const end = endDateFilter.value;

            if (source === 'quarterYear') {
                // If user is using Quarter or Year, disable and clear Start/End
                if (quarter || year) {
                    startDateFilter.value = '';
                    endDateFilter.value = '';
                    startDateFilter.disabled = true;
                    endDateFilter.disabled = true;
                } else {
                    // If they cleared both, re-enable Start/End
                    startDateFilter.disabled = false;
                    endDateFilter.disabled = false;
                }
            } else if (source === 'dateRange') {
                // If user is using Start or End, disable and clear Quarter/Year
                if (start || end) {
                    quarterFilter.value = '';
                    yearFilter.value = '';
                    quarterFilter.disabled = true;
                    yearFilter.disabled = true;
                } else {
                    // If they cleared both, re-enable Quarter/Year
                    quarterFilter.disabled = false;
                    yearFilter.disabled = false;
                }
            }
        }
        // <<< ADDED: Event listeners for time filters >>>
        quarterFilter.addEventListener('change', () => handleTimeFilterChange('quarterYear'));
        yearFilter.addEventListener('change', () => handleTimeFilterChange('quarterYear'));
        startDateFilter.addEventListener('input', () => handleTimeFilterChange('dateRange'));
        endDateFilter.addEventListener('input', () => handleTimeFilterChange('dateRange'));


        // --- Fetch Data Based on Filters and Display ---
        async function fetchDataAndDisplay() {
            loadingDiv.style.display = 'block';
            errorDiv.classList.add('hidden');
            noDataDiv.classList.add('hidden');
            dataTable.classList.add('hidden');
            dataTableBody.innerHTML = '';
            tableNote.classList.add('hidden'); // <<< Hide table note initially
            tableSearchInput.value = ''; // <<< ADDED: Clear search input on new fetch

            // Destroy existing charts
            if (barChartInstance) barChartInstance.destroy();
            if (timeSeriesChartInstance) timeSeriesChartInstance.destroy();
            if (categoryPieChartInstance) categoryPieChartInstance.destroy();

            // Build API URL with Filters
            const params = new URLSearchParams();
            const province = provinceFilter.value;
            const category = categoryFilter.value;
            const municipality = municipalityFilter.value; // <<< ADDED
            const quarter = quarterFilter.value; // <<< ADDED
            const year = yearFilter.value; // <<< ADDED
            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (province) params.append('province', province);
            if (category) params.append('disaster_category', category);
            if (municipality) params.append('municipality', municipality); // <<< ADDED
            if (quarter) params.append('quarter', quarter); // <<< ADDED
            if (year) params.append('year', year); // <<< ADDED
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            params.append('limit', 5000); // Fetch more data for better chart aggregation

            const filteredApiUrl = `${baseApiUrl}?${params.toString()}`;
            console.log("Fetching data from:", filteredApiUrl);

            try {
                const response = await fetch(filteredApiUrl);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errorData = await response.json(); if (errorData && errorData.message) errorMsg += ` - ${errorData.message}`; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const result = await response.json();

                if (result.status === 'success' && result.data && result.data.length > 0) {
                    const data = result.data;
                    console.log(`Filtered data fetched: ${data.length} items`, data.slice(0, 5)); // Log first 5 items

                    // --- 1. Prepare Data for Bar Chart ---
                    let barGroupByKey = 'province';
                    let barChartTitle = 'Total Disaster Losses PHP Grand Total by Province';
                    if (province && !municipality) { barGroupByKey = 'municipality'; barChartTitle = `Losses by Municipality in ${province}`; }
                    else if (province && municipality) { barGroupByKey = 'disaster_category'; barChartTitle = `Losses by Category in ${municipality}`; }
                    else if (!province && category) { barGroupByKey = 'province'; barChartTitle = `Losses from ${category} by Province`; }
                    else if (province && category) { barGroupByKey = 'municipality'; barChartTitle = `Losses from ${category} in ${province}`; }


                    const lossesByBarGroup = data.reduce((acc, item) => {
                        const key = item[barGroupByKey] || 'Unknown';
                        // Ensure losses_php_grand_total is treated as a number
                        const lossValue = parseFloat(item.losses_php_grand_total);
                        acc[key] = (acc[key] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                        return acc;
                    }, {});

                    // Sort groups by loss value descending for bar chart
                    const sortedBarGroups = Object.entries(lossesByBarGroup).sort(([,a],[,b]) => b-a);
                    const barLabels = sortedBarGroups.map(([key]) => key);
                    const barValues = sortedBarGroups.map(([,value]) => value);


                    // --- 2. Prepare Data for Line Chart (Monthly Losses) ---
                    const lossesByMonth = data.reduce((acc, item) => {
                        if (item.event_date_start && item.event_date_start !== null && item.event_date_start !== 'N/A') {
                            const monthYear = dayjs(item.event_date_start).isValid() ? dayjs(item.event_date_start).format('YYYY-MM') : null;
                             if (monthYear) {
                                const lossValue = parseFloat(item.losses_php_grand_total);
                                acc[monthYear] = (acc[monthYear] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                            }
                        }
                        return acc;
                    }, {});
                    const sortedMonths = Object.keys(lossesByMonth).sort();
                    const monthlyLossValues = sortedMonths.map(month => lossesByMonth[month]);

                    // --- 3. Prepare Data for Pie Chart (Category Distribution) ---
                    const lossesByCategory = data.reduce((acc, item) => {
                        const key = item.disaster_category || 'Unknown';
                        const lossValue = parseFloat(item.losses_php_grand_total);
                        acc[key] = (acc[key] || 0) + (isNaN(lossValue) ? 0 : lossValue);
                        return acc;
                    }, {});
                    // Filter out categories with zero loss for pie chart
                    const filteredPieData = Object.entries(lossesByCategory).filter(([,value]) => value > 0);
                    const categoryLabels = filteredPieData.map(([key]) => key);
                    const categoryLossValues = filteredPieData.map(([,value]) => value);


                    // --- Create Bar Chart ---
                    const barCtx = barChartCanvas.getContext('2d');
                    barChartInstance = new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: barLabels, // Use sorted labels
                            datasets: [{
                                label: 'Losses PHP Grand Total',
                                data: barValues, // Use sorted values
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                             }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, indexAxis: 'y', // Make it horizontal for potentially many labels
                             scales: {
                                 y: { // Now the category axis
                                     beginAtZero: true,
                                     title: { display: true, text: barGroupByKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) }
                                 },
                                 x: { // Now the value axis
                                      title: { display: true, text: 'Losses PHP Grand Total' },
                                      ticks: { callback: formatNumber }
                                 }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: barChartTitle, font: { size: 16 } },
                                tooltip: { callbacks: { label: ctx => `Losses PHP Grand Total: ${formatCurrency(ctx.parsed.x)}` } } // x for horizontal bar
                            }
                        }
                    });

                    // --- Create Line Chart ---
                    if (sortedMonths.length > 0) { // Only render if data exists
                        const lineCtx = timeSeriesCanvas.getContext('2d');
                        timeSeriesChartInstance = new Chart(lineCtx, {
                             type: 'line',
                             data: { labels: sortedMonths, datasets: [{ label: 'Monthly Total Losses (PHP)', data: monthlyLossValues, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.1, fill: true }] },
                             options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Losses (PHP)' }, ticks: { callback: formatNumber } }, x: { title: { display: true, text: 'Month' } } }, plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: ctx => `Total Losses: ${formatCurrency(ctx.parsed.y)}` } } } }
                        });
                    } else {
                         // Optionally display a message if no time data
                         const lineCtx = timeSeriesCanvas.getContext('2d');
                         lineCtx.clearRect(0, 0, timeSeriesCanvas.width, timeSeriesCanvas.height);
                         lineCtx.font = '16px "Inter"';
                         lineCtx.fillStyle = '#6b7280';
                         lineCtx.textAlign = 'center';
                         lineCtx.fillText('No monthly data to display.', timeSeriesCanvas.width / 2, timeSeriesCanvas.height / 2);
                    }


                    // --- Create Pie Chart ---
                     if (categoryLabels.length > 0) { // Only render if data exists
                        const pieCtx = categoryPieCanvas.getContext('2d');
                        const pieColors = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(100, 255, 100, 0.7)'];
                        categoryPieChartInstance = new Chart(pieCtx, {
                             type: 'pie',
                             data: { labels: categoryLabels, datasets: [{ label: 'Losses by Category (PHP)', data: categoryLossValues, backgroundColor: pieColors.slice(0, categoryLabels.length), hoverOffset: 4 }] },
                             options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } } } }
                        });
                    } else {
                         const pieCtx = categoryPieCanvas.getContext('2d');
                         pieCtx.clearRect(0, 0, categoryPieCanvas.width, categoryPieCanvas.height);
                         pieCtx.font = '16px "Inter"';
                         pieCtx.fillStyle = '#6b7280';
                         pieCtx.textAlign = 'center';
                         pieCtx.fillText('No category data to display.', categoryPieCanvas.width / 2, categoryPieCanvas.height / 2);
                    }


                    // --- Populate Table (Limited Rows) ---
                    const tableLimit = 100;
                    // <<< UPDATED: Check for farmer data presence to show note >>>
                    let farmerDataAvailable = false;
                    data.slice(0, tableLimit).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 text-sm'; // Ensure consistent text size

                        // <<< ADDED: Check if farmer registry columns exist and have non-null/non-zero values >>>
                        const hasFarmerData = item.registered_rice_farmers !== null && item.registered_rice_farmers !== undefined && item.registered_rice_farmers > 0;
                        if (hasFarmerData) farmerDataAvailable = true;

                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${formatText(item.event_date_start)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${formatText(item.province)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${formatText(item.municipality)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${formatText(item.commodity)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${formatText(item.disaster_category)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700 text-right">${formatCurrency(item.losses_php_grand_total)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700 text-right">${formatInt(item.farmers_affected)}</td>
                            <!-- <<< UPDATED: Use formatters for new columns >>> -->
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700 text-right">${formatRegistryNumber(item.registered_rice_farmers)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700 text-right">${formatRegistryNumber(item.total_declared_rice_area_ha)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700 text-right">${formatPercentage(item.percentage_farmers_affected)}</td>
                        `;
                        dataTableBody.appendChild(row);
                     });
                     dataTable.classList.remove('hidden');
                     // <<< UPDATED: Show note only if farmer data was actually present >>>
                     if (farmerDataAvailable) {
                         tableNote.classList.remove('hidden');
                     }


                    loadingDiv.style.display = 'none';

                } else if (result.status === 'success' && (!result.data || result.data.length === 0)) {
                    loadingDiv.style.display = 'none';
                    noDataDiv.classList.remove('hidden');
                    console.log("API returned success but no data for selected filters.");
                }
                 else {
                     throw new Error(result.message || 'API returned success status but no valid data.');
                }
            } catch (error) {
                console.error('Error fetching or processing data:', error);
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `Error loading data: ${error.message}. Is the API server running and responding correctly?`;
                errorDiv.classList.remove('hidden');
            }
        }

        // --- Event Listener for Filter Button ---
        applyFiltersBtn.addEventListener('click', fetchDataAndDisplay);

        // --- <<< ADDED: Event Listener and Function for Table Search >>> ---
        function filterTable() {
            const searchTerm = tableSearchInput.value.toLowerCase();
            const rows = dataTableBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // Use textContent for a broad search across all row text
                const rowText = row.textContent || row.innerText;

                if (rowText.toLowerCase().indexOf(searchTerm) > -1) {
                    row.style.display = ""; // Show row
                } else {
                    row.style.display = "none"; // Hide row
                }
            }
        }
        tableSearchInput.addEventListener('keyup', filterTable);


        // --- Initial Load ---
        async function initializeDashboard() {
            await populateFilters();
            await fetchDataAndDisplay();
        }

        initializeDashboard();

    </script>

</body>
</html>

